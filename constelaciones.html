<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Titulo</title>
    <script src="estrellas.js"></script>
</head>
<form id="formHora" action="">
    <input id="hora" type="time">
    <input type="submit" onclick="cambiarHora()">
</form>
<body>
<canvas id="canvas" width="700" height="700">
</canvas>
<script>
    var canvas;
    var ctx;
    var escala = 350/90;
    var lat;
    var lon;
    var hora;
    var listaEstrellas = new Array();
    window.onload = inicializar;

    function inicializar() {
        var f=new Date();
        hora = f.getHours();
        if (navigator.geolocation){
            navigator.geolocation.getCurrentPosition(getPosicion);
        }

    }
    function getPosicion(position){
        lat = position.coords.latitude;
        canvas = document.getElementById("canvas");
        ctx = canvas.getContext("2d");
        //Dibujar círculo donde va
        ctx.beginPath();
        ctx.fillStyle="black";
        ctx.strokeStyle="black";
        ctx.arc(350, 350, 350, 0, 2*Math.PI);
        ctx.fill();
        ctx.stroke();
        ctx.closePath();
        // Dibujo de estrellas y constelaciones
        prepararEstrellas();
        dibujarEstrellas();
        dibujarLineas();
    }

    function prepararEstrellas(){
        for (i=0; i<estrellas.length; i++){
            var convertido = traslacion(parseFloat(estrellas[i].RAN), parseFloat(estrellas[i].DECN));
            var estrella = new Object();
            estrella.nombre = estrellas[i].NAME;
            estrella.constelacion = estrellas[i].CON;
            estrella.x = convertido[0];
            estrella.y = convertido[1];
            listaEstrellas.push(estrella);
        }
    }
    function dibujarEstrellas() {

        for (i=0; i<estrellas.length; i++){
            var ran = parseFloat(estrellas[i].RAN*escala)+350;
            var decn = parseFloat(estrellas[i].DECN*escala)+350-parseFloat(lat)*(350/90);
            var mag = parseFloat(estrellas[i].MAG);

            var radio = 0;
            if(mag<4 && mag >2){
                radio=1;
            }
            else if (mag < 2 && mag > 0){
                radio=2;
            }
            else if (mag < 0){
                radio=4;
            }
            else if(mag > 4){
                radio = 0.5;
            }
            ctx.beginPath();
            ctx.fillStyle="white";
            ctx.strokeStyle="white";
            ctx.arc(ran, decn, radio, 0, 2*Math.PI);
            ctx.fill();
            ctx.stroke();
            ctx.closePath();
        }
    }
    function dibujarLineas() {

        for (i=0; i < estrellas.length; i++){
            //1. Cojo estrella actual
            var ranactual = parseFloat(estrellas[i].RAN);
            var decnactual = parseFloat(estrellas[i].DECN);
            //2. Compruebo que sea correcta (no nula)
            if (ranactual != null && decnactual != null){
                var ransig = parseFloat(estrellas[i+1].RAN);
                var decnsig = parseFloat(estrellas[i+1].DECN);
                var aux = i+1;
                if (ransig != null && decnsig != null && aux<estrellas.length){
                    //3. Dibujar línea
                    ctx.beginPath();
                    var x = (ranactual*escala)+350;
                    var y = (decnactual*escala)+350-parseFloat(lat)*(350/90);
                    ctx.moveTo(x,y);
                    var x1 = (ransig*escala)+350;
                    var y1 = (decnsig*escala)+350-parseFloat(lat)*(350/90);
                    ctx.lineTo(x1,y1);
                    ctx.strokeStyle="white";
                    ctx.stroke();
                    ctx.closePath();
                }
                else{
                    i++;
                }
            }
        }
    }
    function cambiarHora() {
        var nuevahora = document.forms["formHora"]["hora"].value;
        alert("Nueva hora "+nuevahora);
    }

    function traslacion(ran, decn){
        var convertido=[ran,decn];
        var a=350;
        var b=350/90*lat;
        var f=new Date();
        var alfa=(360/24) * hora;
        alfa=alfa*Math.PI/180;
        convertido[0]=(ran-a)*Math.cos(alfa)-(decn-b)*Math.sin(alfa)+a;
        convertido[1]=(ran-a)*Math.sin(alfa)+(decn-b)*Math.cos(alfa)+b;
        alert("x = "+convertido[0]+" y = "+convertido[1]);
        return convertido;
    }

</script>

</body>
</html>